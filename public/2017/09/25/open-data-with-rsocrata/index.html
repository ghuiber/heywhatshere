<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.27.1" />


<title>Open data with RSocrata - Hey, what&#39;s here?</title>
<meta property="og:title" content="Open data with RSocrata - Hey, what&#39;s here?">



  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/mugshot.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://github.com/ghuiber/heywhatshere">GitHub</a></li>
    
    <li><a href="https://www.linkedin.com/in/ghuiber/">LinkedIn</a></li>
    
    <li><a href="mailto:ghuiber@gmail.com">Mail</a></li>
    
    <li><a href="https://twitter.com/ghuiber">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    

    <h1 class="article-title">Open data with RSocrata</h1>

    
    <span class="article-date">2017/09/25</span>
    

    <div class="article-content">
      <p>San Francisco has an <a href="https://datasf.org/">open data site</a> built with <a href="https://dev.socrata.com/">Socrata</a>. There’s an <a href="https://cran.r-project.org/web/packages/RSocrata/index.html">RSocrata</a> package on CRAN, so it should be easy enough to analyze this data in R.</p>
<p>Here’s an attempt:</p>
<pre class="r"><code># load useful libs first
library(&#39;RSocrata&#39;)
library(&#39;tidyverse&#39;)
library(&#39;lubridate&#39;)
library(&#39;survival&#39;)
library(&#39;survminer&#39;)
# bring remote json into local tibble
biz_locations &lt;- read.socrata(url = &#39;https://data.sfgov.org/resource/vbiu-2p9h.json&#39;) %&gt;% 
  as_tibble()</code></pre>
<p>Let’s track business survival over time.</p>
<pre class="r"><code># I want SF only and unique certificate-numbers 
# with dba start and end dates since 1999
plotthese &lt;- biz_locations %&gt;% 
  filter(city %in% 
           c(&#39;San Francisco&#39;, &#39;San+francisco&#39;)) %&gt;% 
  select(certificate_number, 
         business_zip, 
         dba_start_date, 
         dba_end_date) %&gt;% 
  unique() %&gt;%   
  filter(year(dba_start_date) &gt;= 1999) %&gt;% 
  mutate(closed = !is.na(dba_end_date)) %&gt;% 
  mutate(dba_end_date = if_else(closed == FALSE, 
                                Sys.Date() %&gt;% 
                                  as_datetime(), 
                                dba_end_date)) %&gt;% 
  mutate(year = year(dba_start_date))
# My models
formulas &lt;- list(null_model = Surv(time = difftime(dba_end_date, 
                                                   dba_start_date, 
                                                   units = &#39;weeks&#39;), 
                                   closed) ~ 1L,
                 by_year = Surv(time = difftime(dba_end_date, 
                                                dba_start_date, 
                                                units = &#39;weeks&#39;), 
                                closed) ~ I(year))
fitset &lt;- surv_fit(formulas, 
                   data = plotthese,
                   conf = &#39;log-log&#39;)
plotset &lt;- fitset %&gt;% 
  map(ggsurvplot)</code></pre>
<p>There’s something wrong with this SF business registration data. It makes no sense that older cohorts should have such robust survival profiles, with hardly any of the businesses registered in 1999 closing down over their first 10 years in existence:</p>
<pre class="r"><code>plotset$`plotthese::by_year` + 
  ggtitle(&#39;Survival profile by registration year&#39;)</code></pre>
<p><img src="/post/2017-09-25-open-data-with-rsocrata_files/figure-html/showFunnySurvival-1.png" width="672" /></p>
<p>It seems like we have a selection problem. The farther we go into the past, the more the data set is biased toward businesses that have longer survival.</p>
<p>Maybe older businesses that failed at earlier times were simply ignored. The masthead says that this data set is maintained by the Office of the Treasurer-Tax Collector <a href="https://data.sfgov.org/Economy-and-Community/Registered-Business-Locations-San-Francisco/g8m3-pdis/data">here</a>. It’s possible that defunct businesses are gradually erased from the tax rolls as a routine matter of record-keeping hygiene. That’s unfortunate for our purposes.</p>
<p>Let’s take a closer look at a smaller example anyway, see if we can find some simple piece of evidence in favor of this bias through data-cleaning theory.</p>
<p>First, we’ll select two years that are close together and recent, but not too recent. We want them recent because if older data are incomplete and biased to favor businesses with better survival, more recent years should be less affected; and we don’t want them too recent because we want to see some meaningful length of the uncensored segment of the survival curve.</p>
<p>Next, we’ll select two years that are far apart, so one will have to be fairly recent. It will suffer from censoring over most of the length of the observed curve, but the previous pair will have given us an idea of what to expect the survival curve to look like.</p>
<pre class="r"><code># take two years close together and with
# a few years of history trailing them
closepair &lt;- c(2015, 2016)
# and take two years fairly far apart
farpair   &lt;- c(2000, 2012)
# now compare the survival plots by year
foo &lt;- list(close = closepair, 
            far = farpair) %&gt;% 
  map(function(x) 
    plotthese %&gt;% 
      filter(year %in% x)) %&gt;% 
  map(surv_fit, 
      formula = formulas$by_year, 
      conf = &#39;log-log&#39;)
survminerplots &lt;- foo %&gt;% 
  map(ggsurvplot, 
      risk.table = TRUE)
survminerplots$close + 
  ggtitle(&#39;Believable survival curves&#39;)</code></pre>
<p><img src="/post/2017-09-25-open-data-with-rsocrata_files/figure-html/showASmallerExample-1.png" width="672" /></p>
<pre class="r"><code>survminerplots$far + 
  ggtitle(&#39;Survivor bias in older cohort&#39;)</code></pre>
<p><img src="/post/2017-09-25-open-data-with-rsocrata_files/figure-html/showASmallerExample-2.png" width="672" /></p>
<p>The above gave us more information than we strictly need. A quicker way to show this survivor bias in older firms is a simple tally.</p>
<pre class="r"><code># older firms have better survival than newer ones.
# difference hard to see in close-together years,
# not so in far-apart years
# tally closures by year, by cohort of birth
tallies &lt;- list(close = closepair, 
                far = farpair) %&gt;% 
  map(function(x) 
    plotthese %&gt;% 
      filter(year %in% x)) %&gt;% 
  map(function(x) 
    x %&gt;% 
      mutate(end_year = year(dba_end_date)) %&gt;% 
      filter(closed == TRUE) %&gt;% 
      group_by(year, end_year) %&gt;% 
      tally())
# tabulate closed vs still open by cohort of birth
totes &lt;- list(close = closepair, 
                far = farpair) %&gt;% 
  map(function(x) 
    plotthese %&gt;% 
      filter(year %in% x)) %&gt;% 
  map(function(x) 
    x %&gt;% 
      group_by(year, closed) %&gt;% 
      tally()) %&gt;% 
  map(function(x) 
    x %&gt;% 
      tidyr::spread(n, key = closed) %&gt;% 
      mutate(share_closed = `TRUE`/(`TRUE`+`FALSE`)))</code></pre>
<p>It is hard to believe that of the businesses registered in 2000 a smaller share is now closed than of the businesses registered in 2012. Even if we expect poorer overall survival as the mix of businesses registered in San Francisco is increasingly weighted toward tech startups as time goes on, would this effect would more than offset the sheer size of the cumulative risk of closure faced by older enterprises? And yet that is what we see:</p>
<pre class="r"><code>totes$far %&gt;% 
  knitr::kable(col.names = c(&#39;Year registered&#39;, 
                             &#39;Still open&#39;, 
                             &#39;Now closed&#39;, 
                             &#39;Share of closed&#39;), 
               digits = 2, 
               format.args = list(big.mark = &#39;,&#39;))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">Year registered</th>
<th align="right">Still open</th>
<th align="right">Now closed</th>
<th align="right">Share of closed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2,000</td>
<td align="right">1,820</td>
<td align="right">472</td>
<td align="right">0.21</td>
</tr>
<tr class="even">
<td align="right">2,012</td>
<td align="right">6,198</td>
<td align="right">2,635</td>
<td align="right">0.30</td>
</tr>
</tbody>
</table>
<p>The most dramatic way to illustrate survivor bias is simply to tally the closures in the first 5 years from the year of registration by cohort:</p>
<pre class="r"><code>tallies$far %&gt;% 
  group_by(year) %&gt;% 
  arrange(year, end_year) %&gt;% 
  filter(row_number() &lt;= 5) %&gt;% 
  knitr::kable(col.names = c(&#39;Year of registration&#39;, 
                             &#39;Year of closure&#39;, 
                             &#39;Businesses closed&#39;), 
               digits = 2)</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">Year of registration</th>
<th align="right">Year of closure</th>
<th align="right">Businesses closed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2000</td>
<td align="right">2000</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="right">2002</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">2000</td>
<td align="right">2004</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="right">2006</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="right">2000</td>
<td align="right">2007</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2012</td>
<td align="right">2012</td>
<td align="right">249</td>
</tr>
<tr class="odd">
<td align="right">2012</td>
<td align="right">2013</td>
<td align="right">364</td>
</tr>
<tr class="even">
<td align="right">2012</td>
<td align="right">2014</td>
<td align="right">672</td>
</tr>
<tr class="odd">
<td align="right">2012</td>
<td align="right">2015</td>
<td align="right">688</td>
</tr>
<tr class="even">
<td align="right">2012</td>
<td align="right">2016</td>
<td align="right">445</td>
</tr>
</tbody>
</table>
<p>It is even harder to believe that none of the businesses registered in 2000 closed in 2001, 2003, or 2005, and as far out as 2007 the closures in this cohort are in the single digits per year. This data set is incomplete.</p>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

